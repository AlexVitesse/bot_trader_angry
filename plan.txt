ROADMAP: BOT DE TRADING ML - TRADER PROFESIONAL AUTONOMO
=========================================================
META: Bot que analiza el mercado, elige la estrategia correcta, y apuesta
fuerte cuando tiene confianza alta. Como un trader profesional, pero automatizado.

Ultima actualizacion: 2026-02-14

[ESTADO ACTUAL]
Fase: FASE 3 - ML TRADER PROFESIONAL (EN PROGRESO)
Proximo Hito: PASO 5 - Paper Trading en Demo (2 semanas)
Infraestructura: Bot completo + ML integrado + Demo Trading conectado - LISTO.
Pipeline ML: 13 modelos (1 MacroScorer + 11 Signals V7 + 1 ConvictionScorer)

---

PROGRESO ML (Investigacion completada):
  V1: Clasificacion 1m, 32 features          -> AUC 0.53 (random), NO rentable
  V2: +MTF features + Optuna, 7 labeling     -> AUC 0.60, NO rentable (PF<1)
  V3: Regresion + walk-forward, 1m           -> Corr 0.05, NO rentable
  V4: Trend following 4h/daily               -> PRIMER RESULTADO RENTABLE (PF 1.37-1.67)
  V5: Multi-par (5) + compounding            -> 25% anual, DD 34%
  V6: Regime detection + 15 pares            -> 262% anual PERO DD 83% (inaceptable)
  V7: Risk management + trailing stop        -> 322% anual, DD 10%, PF 1.37, Sharpe 4.05
  V8: Alternative data (funding + F&G)       -> Features integrados en pipeline
  V8.4: MacroScorer (DXY,Gold,SPY,TNX,ETH/BTC) -> Adaptive threshold + ML sizing + risk-off
  V8.5: ConvictionScorer (per-trade PnL)     -> Sizing dinamico + filtro de trades malos

LECCIONES CLAVE:
  - 1 minuto NO funciona: ruido > senal, edge arbitrado, costos altos
  - 4h/daily SI funciona: TA fue disenado para estos timeframes
  - Multi-par multiplica oportunidades (11-15 pares)
  - Regime detection mejora retorno (BULL=solo LONG, BEAR=solo SHORT)
  - SIN risk management el bot es un apostador, no un trader
  - Compounding amplifica TODO -> flat sizing es mas estable
  - Trailing stop es clave: +$1,360 extra capturados vs TP fijo
  - ATR adaptativo causa kill switch rapido -> TP/SL fijo es mejor
  - Position cap necesario para evitar numeros fantasiosos
  - Daily loss limit debe basarse en INITIAL_CAPITAL (capital real), NO en balance testnet

---

FASE 0-2: INFRAESTRUCTURA (COMPLETADA)
[X] Conexion Binance (REST + WebSocket)
[X] Motor de trading (DCA, TP/SL, ordenes)
[X] Base de datos SQLite (trades, features, candles, posicion)
[X] Telegram alerts (trades, kill switch, resumen diario)
[X] Kill switches basicos (3 losses consecutivas, 20% DD diario)
[X] Deploy en VPS (systemd, logrotate)

---

FASE 3: ML TRADER PROFESIONAL

  PASO 1 - Investigacion ML (COMPLETADO)
  [X] 7 versiones probadas (V1-V7)
  [X] Timeframe optimo: 4h
  [X] Modelo: LightGBM regresion (predice retorno futuro 5 velas = 20h)
  [X] 35 features: retornos, volatilidad, momentum, tendencia, volumen, ADX, temporal
  [X] Regime detection: BTC daily -> BULL/BEAR/RANGE
  [X] Walk-forward: 4/4 folds rentables en todos los tests

  PASO 2 - V7: Risk Management Profesional (COMPLETADO)
  [X] Max 3 posiciones concurrentes (evitar correlacion)
  [X] Max drawdown 20% -> pausar bot (kill switch de portafolio)
  [X] Max perdida diaria 5% -> pausar ese dia
  [X] Trailing stop: dejar correr ganancias (+$1,360 capturados)
  [X] Position sizing: flat $50 notional por trade (basado en INITIAL_CAPITAL)
  [X] Confidence scaling: modelo seguro = mas riesgo, modelo dudoso = menos
  [X] Filtro MIN_TRAIN_CANDLES: omitir pares con datos insuficientes

  PASO 3 - Validacion Rigurosa (COMPLETADO - todos los criterios superados)
  [X] Walk-forward 4+ folds, TODOS rentables -> 4/4 (PF 1.54, 1.71, 1.87, 1.27)
  [X] Max DD < 25% en backtest -> 10.2%
  [X] PF > 1.2 neto (con comisiones 0.04% + slippage 0.01%) -> 1.37
  [X] Retorno anual > 30% -> 322.7%
  [X] Sharpe ratio > 1.0 -> 4.05
  [X] Funcionar en BULL, BEAR y RANGE -> BULL +$760, BEAR +$252, RANGE +$997

  CONFIG GANADORA: FLAT + Trailing Stop
    $100 -> $2,109 en 2.1 anos | 322% anual | DD 10% | Sharpe 4.05
    4,471 trades | WR 51% | 21/26 meses positivos (81%)
    11 pares: BTC ETH SOL BNB XRP DOGE ADA AVAX LINK DOT NEAR

  PASO 4 - Integracion en Bot Live (COMPLETADO)
  [X] src/ml_strategy.py: cerebro ML (features, predicciones, regime detection)
  [X] src/portfolio_manager.py: multi-posicion, sizing, trailing, kill switch
  [X] src/ml_bot.py: loop principal (30s check, 4h senales, Telegram)
  [X] ml_export_models.py: entrenamiento y exportacion de 11 modelos
  [X] Binance Demo Trading API conectada (demo-fapi.binance.com)
  [X] Balance real demo: $4,506 USDT | 11 modelos cargados
  [X] Regime detection funcionando (BEAR detectado correctamente)
  [X] Status log cada 10 min, resumen diario 23:55 UTC

  PASO 4.5 - V8 Mejoras Pipeline ML (COMPLETADO)
  [X] V8: Alternative data features (funding rate + Fear & Greed Index)
      - alt_data_collector.py: recolecta funding rate desde Binance API
      - alt_data_fetcher.py: obtiene Fear & Greed Index
  [X] V8.4: MacroScorer - inteligencia macro diaria
      - Analiza DXY, Gold, SPY, TNX, ETH/BTC para contexto macro
      - Adaptive threshold: ajusta umbral de senales segun macro score
      - ML sizing: factor de tamano basado en condiciones macro
      - Soft risk-off: reduce exposicion cuando macro es desfavorable (no pausa total)
      - ml_train_v84.py: entrenamiento del modelo macro
      - macro_data.py: fetcher de datos macro (yfinance)
  [X] V8.5: ConvictionScorer - prediccion PnL por trade
      - Predice PnL esperado ANTES de abrir cada trade
      - Sizing dinamico: mas capital en trades de alta conviccion
      - Filtro: rechaza trades con PnL esperado negativo
      - ml_train_v85.py: entrenamiento del scorer
  [X] Fix: entry price mismatch auto-correction (DB vs Exchange >1%)
  [X] Fix: daily loss warning spam (solo logea pausa 1 vez)
  [X] Fix: duplicate position prevention (verifica exchange antes de abrir)
  [X] Test suite pre-launch: 44 tests, todos pasando
      - test_bot_prelaunch.py: valida configuracion, modelos, risk, signals

  PIPELINE COMPLETO (13 modelos):
    MacroScorer (diario) -> Regime (reglas BTC) -> V7 Signals (4h, 11 pares)
    -> ConvictionScorer (per-trade) -> PortfolioManager (sizing + risk)

  3 REGIMENES:
    BULL  -> Solo LONG  (BTC EMA20 > EMA50 y ret_20d > 0)
    BEAR  -> Solo SHORT (BTC EMA20 < EMA50 y ret_20d < 0)
    RANGE -> LONG y SHORT (cualquier otra combinacion)

  TIPO DE TRADER: Swing trader
    - Timeframe: 4h
    - Hold time: 1-15 velas (4 horas a ~2.5 dias)
    - Max 3 posiciones simultaneas
    - Sizing FLAT basado en INITIAL_CAPITAL (sin interes compuesto)

  PASO 5 - Paper Trading en Demo (EN PROGRESO - INICIADO 2026-02-12)
  [ ] Minimo 2 semanas en demo con dinero virtual ($4,506)
  [ ] Verificar que abre/cierra trades correctamente
  [ ] Verificar trailing stop funciona en live
  [ ] Comparar resultados live vs backtest
  [ ] Criterio para ir a real: PF > 1.2, DD < 20%, > 30 trades
  [ ] Monitorear logs diariamente los primeros dias
  [ ] 26 Feb: Borrar contador de demo en _send_heartbeat() (ml_bot.py linea ~398)

---

FASE 4: DINERO REAL (~Marzo 2026)
  Pre-requisito: Fase 3 PASO 5 exitoso (PF > 1.2, DD < 20%, > 30 trades en demo).

  Comandos Telegram implementados:
  [X] /status - Balance, posiciones abiertas, PnL del dia, regime actual
  [X] /positions - Detalle de cada posicion (par, side, entry, PnL%, trailing)
  [X] /close [par] - Cerrar posicion especifica manualmente
  [X] /close_all - Cerrar todas las posiciones (emergencia)
  [X] /pause - Pausar bot (no abre nuevos trades, mantiene posiciones)
  [X] /resume - Reanudar bot (resetea daily_pnl para evitar re-pausa)
  [X] /stats - Resumen: trades hoy, WR, PF, mejor/peor trade
  [X] /regime - Regime actual + datos BTC (EMA20/50, ret20d)
  [X] /log - Envia archivo de log por Telegram
  [X] Autenticacion: solo responde a TELEGRAM_CHAT_ID autorizado

  Comandos Telegram pendientes:
  [ ] /config - Ver config actual (leverage, TP/SL, max concurrent)

  Capital y Sizing:
  [ ] Capital inicial: $100 (minimo para probar)
  [ ] Primeras 2 semanas: sizing ultra conservador (1% riesgo)
  [ ] Si rentable 2 semanas: subir a 2% riesgo
  [ ] Si rentable 1 mes: escalar gradualmente sizing
  [ ] Para aumentar capital: cambiar INITIAL_CAPITAL manualmente en settings.py
  [ ] VPS 24/7 (~$5/mes: Hetzner, DigitalOcean, Contabo, AWS Lightsail)
  [ ] Reentrenamiento mensual del modelo (ml_export_models.py)

  Requerimientos VPS:
    Minimo: 1 core, 1GB RAM, 500MB disco, 1Mbps red estable
    Recomendado: 2 cores, 2GB RAM, 2GB SSD, 10Mbps red
    Ubicacion ideal: Frankfurt, Singapur o Tokyo (cerca de Binance)

---

FASE 5: MULTI-TIMEFRAME + MULTI-ESTRATEGIA (~Abril-Mayo 2026)
  Objetivo: Adaptarse al mercado como un trader profesional.
  Nota: V8 alternative data YA esta integrado (movido a Paso 4.5).

  Multi-Timeframe:
  [ ] Agregar features de Daily (contexto macro: tendencia, volatilidad)
  [ ] Agregar features de 1h (timing fino: momentum intradia)
  [ ] Modelo recibe contexto de 3 timeframes: 1h + 4h + daily
  [ ] Backtest MTF vs V8: medir mejora
  [ ] CUIDADO: look-ahead bias en MTF -> usar .shift(1) antes de .reindex()

  Multi-Estrategia (adaptar segun mercado como trader profesional):
  Modelos especializados:
  [ ] Modelo A: Trend Following (actual V7) - para tendencias claras BULL/BEAR
      - Seguir momentum, dejar correr ganancias con trailing stop
      - Funciona mejor cuando ADX > 25 (tendencia fuerte)
  [ ] Modelo B: Mean Reversion - para mercados laterales RANGE
      - Comprar en soporte (BB inferior), vender en resistencia (BB superior)
      - TP mas pequeno pero WR mas alto, funciona cuando ADX < 20
  [ ] Modelo C: Momentum/Breakout - para inicio de tendencia nueva
      - Detectar cuando el precio rompe un rango, entrar rapido
      - Funciona en transiciones RANGE->BULL o RANGE->BEAR

  Meta-Modelo (el "cerebro" que elige):
  [ ] Entrenar modelo clasificador que predice: cual estrategia sera rentable?
      Input: features de mercado (volatilidad, ADX, regime, volumen, OI)
      Output: probabilidad de exito de cada estrategia (A, B o C)
  [ ] El meta-modelo evalua cada 4h y asigna peso a cada estrategia
      Ejemplo: mercado lateral -> 70% Mean Reversion, 20% Trend, 10% Breakout
  [ ] Cada estrategia genera senales independientes, el meta-modelo decide cual ejecutar
  [ ] Backtest multi-estrategia vs V7 single: debe superar PF y reducir DD
  [ ] Walk-forward del meta-modelo: evitar overfitting en la seleccion

---

FASE 6: DATOS AVANZADOS (~Junio 2026)
  Objetivo: Agregar datos que la mayoria de bots NO usan.
  [ ] Open Interest como feature (acumulacion de posiciones apalancadas)
  [ ] Long/Short Ratio como feature (indicador contrarian)
  [ ] Liquidation data (cascadas de liquidacion = oportunidades)
  [ ] Order book depth / imbalance (presion compradora/vendedora)
  [ ] ETF flows (entradas/salidas de fondos institucionales)
  [ ] Reentrenar modelos con nuevos features
  [ ] Backtest vs version anterior: debe superar PF y DD

---

FASE 7: ESCALADO AVANZADO (Largo Plazo)
  [ ] Mas pares (20-30 de los mas liquidos)
  [ ] Multi-exchange (Binance + Bybit para mas liquidez)
  [ ] Dashboard web para monitoreo visual
  [ ] Interes compuesto opcional (config para reinvertir ganancias)
  [ ] Analista LLM: pausar bot en eventos macro (FOMC, CPI, hacks, crash)
  [ ] Infraestructura: si latencia importa, reescribir en Rust/C++

---

ARCHIVOS PRINCIPALES:
  config/settings.py       - Toda la configuracion (ML section al final)
  src/ml_bot.py            - Bot principal (loop 30s, senales cada 4h, Telegram)
  src/ml_strategy.py       - Cerebro ML (features, predicciones, regime, macro, conviction)
  src/portfolio_manager.py - Gestion multi-posicion (sizing, trailing, risk, kill switch)
  ml_export_models.py      - Entrenamiento y exportacion de modelos (correr mensual)
  ml_train_v84.py          - Entrenamiento MacroScorer
  ml_train_v85.py          - Entrenamiento ConvictionScorer
  macro_data.py            - Fetcher de datos macro (DXY, Gold, SPY, TNX, ETH/BTC)
  alt_data_collector.py    - Recolector de funding rate (Binance API)
  alt_data_fetcher.py      - Fetcher de Fear & Greed Index
  test_bot_prelaunch.py    - Test suite pre-launch (44 tests)
  models/v7_*.pkl          - Modelos V7 por par (11 archivos)
  models/v7_meta.json      - Metadata V7 (features, pares, config)
  models/v84_meta.json     - Metadata MacroScorer
  models/v85_meta.json     - Metadata ConvictionScorer

---

TIMELINE ESTIMADO:
  Feb 12 - Feb 26: Paper trading demo (PASO 5 actual)
  Mar 2026: Dinero real conservador ($100)
  Abr-May 2026: Multi-timeframe + multi-estrategia
  Jun 2026: Datos avanzados (OI, liquidaciones, order book)
  Jul+ 2026: Escalado avanzado
